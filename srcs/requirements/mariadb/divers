#!/bin/bash


# Vérification des variables d'environnement
if [ -z "$SQL_DATABASE" ] || [ -z "$SQL_USER" ] || [ -z "$SQL_PASSWORD" ] || [ -z "$SQL_ROOT_PASSWORD" ]; then
  echo "Erreur : certaines variables d'environnement ne sont pas définies."
  exit 1
fi

# Démarrer le serveur MariaDB sans forker en arrière-plan
mysqld_safe --skip-networking &
pid="$!"

# Attendre que le serveur soit prêt
while ! mysqladmin ping --silent; do
  sleep 1
done

# Création de la base de données et des utilisateurs
mysql -uroot <<-EOSQL
  CREATE DATABASE IF NOT EXISTS \`${SQL_DATABASE}\`;
  CREATE USER IF NOT EXISTS \`${SQL_USER}\`@'%' IDENTIFIED BY '${SQL_PASSWORD}';
  GRANT ALL PRIVILEGES ON \`${SQL_DATABASE}\`.* TO \`${SQL_USER}\`@'%';
  ALTER USER 'root'@'localhost' IDENTIFIED BY '${SQL_ROOT_PASSWORD}';
  FLUSH PRIVILEGES;
EOSQL

# Arrêter le serveur proprement
mysqladmin -uroot -p"${SQL_ROOT_PASSWORD}" shutdown

# Relancer le serveur MariaDB en mode sécurisé
exec mysqld_safe
